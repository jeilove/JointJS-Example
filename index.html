<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="styles/joint.css" />
    <script src="scripts/jquery.min.js"></script>
    <script src="scripts/lodash.min.js"></script>
    <script src="scripts/backbone-min.js"></script>
    <script src="scripts/graphlib.min.js"></script>
    <script src="scripts/dagre.min.js"></script>
    <script src="scripts/joint.js"></script>
    <script src="scripts/joint.layout.DirectedGraph.js"></script>
</head>
<body>
  <div id="paper"></div>
  <script type="text/javascript">
     joint.shapes.basic.Server = joint.shapes.basic.Generic.extend({
        markup: '<g class="rotatable"><g class="scalable"><path class="path1" d="M512 0c-282.77 0-512 71.634-512 160v128c0 88.366 229.23 160 512 160s512-71.634 512-160v-128c0-88.366-229.23-160-512-160z"></path><path class="path2" d="M512 544c-282.77 0-512-71.634-512-160v192c0 88.366 229.23 160 512 160s512-71.634 512-160v-192c0 88.366-229.23 160-512 160z"></path><path class="path3" d="M512 832c-282.77 0-512-71.634-512-160v192c0 88.366 229.23 160 512 160s512-71.634 512-160v-192c0 88.366-229.23 160-512 160z"></path></g></g>',

        defaults: joint.util.deepSupplement({
            type: 'basic.Server',
            attrs: {
                'path': { fill: '#f86e00'}
            }
        }, joint.shapes.basic.Generic.prototype.defaults)
    });
      
    var graph = new joint.dia.Graph;

    var paper = new joint.dia.Paper({
        el: $('#paper'),
        width: 2000,
        height: 2000,
        gridSize: 1,
        model: graph,
        //interactive: false,//set edit false for now
        embeddingMode: true
    });
    
    function createServer(name) {
//		return new joint.shapes.basic.Server({
//			size: { width: 50, height: 50 },
//			attrs: { text: { text: name } }
//		});
        return new joint.shapes.basic.Rect({
			size: { width: 100, height: 30 },
			attrs: { rect: { stroke: 'grey', fill: "#ddd"},text: { text: 'CI - '+name, fill: 'black' } }
		});
	}
	
	function createLink(src, des){
		return new joint.dia.Link({
			source: { id: src.id },
			target: { id: des.id }
		}).attr({
            '.connection': { stroke: 'grey' },
            '.marker-target': { fill: 'grey', d: 'M 10 0 L 0 5 L 10 10 z' }
        });
	}
    
    var minus = new joint.shapes.basic.Rect({
        size: { width: 60, height: 20 },
        attrs: { text: { text: ' Collapse ', fill: 'black' } }
    });
     var plus = new joint.shapes.basic.Rect({
        size: { width: 60, height: 20 },
        attrs: { text: { text: ' Expand ', fill: 'black' } }
    });
    var start = createServer("start");
    var end = createServer("end");
    var outerRect;

    var outerlinks = [];
    
    paper.on('cell:pointerclick', 
        function(cellView, evt, x, y) { 
            console.log("Clicked");
            console.log(cellView.model);
            if(cellView.model.id === minus.id) {
                console.log('minus clicked');
                
                plus.position(outerRect.attributes.size.width/2 - 30, outerRect.attributes.size.height/2 - 10);
                outerRect.remove()
                graph.addCell(plus);
                graph.addCell(createLink(start, plus));
                graph.addCell(createLink(plus, end));
            }
            if (cellView.model.id === plus.id){
                graph.clear();
                outerlinks = [];
                renderExpandedTopology();
                //graph.addCells(outerlinks);
                graph.addCells([start, end]);
    graph.addCells(outerlinks);

    joint.layout.DirectedGraph.layout(graph, { setLinkVertices: false });
            }
        }
    );
      
    function buildServerGraphFromDependency(adjacencyList) {
        var temp = [];
        var elements = [];
        var links = [];
        _.each(adjacencyList, function(edges, parentElementLabel) {
            var src;
            src = createServer(parentElementLabel);
            temp[parentElementLabel] = src;            
            elements.push(src);
            //do this for all parent nodes - currently hadcoding relation
            if(parentElementLabel === 'A' || parentElementLabel === 'B'){
                outerlinks.push(createLink(start, temp[parentElementLabel]));
            }
            //do this for all leaf nodes - currently hadcoding relation
            if(parentElementLabel === 'Y' || parentElementLabel === 'Z'){
                outerlinks.push(createLink(temp[parentElementLabel], end));
            }
        });
        _.each(adjacencyList, function(edges, parentElementLabel) {
            var src = temp[parentElementLabel];
            _.each(edges, function(childElementLabel) {
                var des = temp[childElementLabel];
                links.push(createLink(src, des));
            });
        });

        // Links must be added after all the elements. This is because when the links
        // are added to the graph, link source/target
        // elements must be in the graph already.
        return elements.concat(links);
    }
          
    var topo = {
        'A' : ['C', 'D',],
        'B' : ['D', 'E'],
        'C' : ['F'],
        'D' : ['F'],
        'E' : ['Y'],
        'F' : ['Z'],
        'Y' : [],
        'Z' : []
    }
      
    
    renderExpandedTopology();

    graph.addCells([start, end]);
    graph.addCells(outerlinks);

    joint.layout.DirectedGraph.layout(graph, { setLinkVertices: false });
    //add start and end nodes after adding others in a container.
    

    function renderExpandedTopology () {
        var cells = buildServerGraphFromDependency(topo);
    cells.push(minus);
    graph.addCells(cells);
    joint.layout.DirectedGraph.layout(graph, { setLinkVertices: false });
    //this is required to put all nodes under a container
    var bbox = graph.getBBox(graph.getElements());
    outerRect = new joint.shapes.basic.Rect({
        position: { x: bbox.x - 10, y: bbox.y - 10 },
        size: { width: bbox.width + 20, height: bbox.height + 20 },
        attrs: { rect: { stroke: '#ccc', fill:"transparent" }}
    });
    graph.addCell(outerRect);
    _.each(cells, function(cell){
        if(!cell.isLink()) {
            outerRect.embed(cell);
        }        
    }); 
    outerRect.embed(minus);
    minus.toFront();
    //required to give container padding
    outerRect.translate(10, 10);
    }
        
  </script>
  
</body>
</html>